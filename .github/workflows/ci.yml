name: CI

on:
  push:
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # IMPORTANT : n√©cessaire pour que git diff voie le commit de base
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_pgsql, intl, mbstring, zip, xml, dom
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install Symfony CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | sudo -E bash
          sudo apt install symfony-cli

      - name: Set up Docker Compose
        id: docker-compose
        run: |
          # V√©rifier si docker-compose est disponible, sinon utiliser docker compose
          if command -v docker-compose &> /dev/null; then
            echo "cmd=docker-compose" >> $GITHUB_OUTPUT
          else
            echo "cmd=docker compose" >> $GITHUB_OUTPUT
          fi

      - name: Start Docker Compose services
        run: ${{ steps.docker-compose.outputs.cmd }} up -d

      - name: Wait for database to be ready
        run: |
          DOCKER_CMD="${{ steps.docker-compose.outputs.cmd }}"
          until $DOCKER_CMD exec -T database pg_isready -U ${POSTGRES_USER:-app} -d ${POSTGRES_DB:-app}; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Wait for FusionAuth to be ready
        run: |
          DOCKER_CMD="${{ steps.docker-compose.outputs.cmd }}"
          echo "Waiting for FusionAuth to be ready..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s http://localhost:9011/api/status > /dev/null 2>&1; then
              echo "FusionAuth is ready!"
              break
            fi
            echo "Waiting for FusionAuth... (attempt $((attempt+1))/$max_attempts)"
            sleep 5
            attempt=$((attempt+1))
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "FusionAuth failed to start after $max_attempts attempts"
            exit 1
          fi

      - name: Composer security audit
        run: composer audit

      # --- IA / Ollama ---

      - name: Setup Ollama
        uses: ai-action/setup-ollama@v1

      - name: Cache Ollama models
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-ollama-

      - name: Pull LLM model
        run: |
          ollama pull llama3.2
          - name: SOLID check with Ollama
          id: solid-check
          # ‚ö†Ô∏è On laisse le script PHP faire exit 1,
          # mais on dit √† GitHub "ne stoppe pas le job pour autant"
          continue-on-error: true
          run: |
            # D√©terminer la r√©f√©rence de base selon le contexte
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_REF="${{ github.event.pull_request.base.sha }}"
              HEAD_REF="${{ github.event.pull_request.head.sha }}"
            else
              BASE_REF="${{ github.event.before }}"
              HEAD_REF="${{ github.sha }}"
            fi
  
            echo "Base ref: $BASE_REF"
            echo "Head ref: $HEAD_REF"
  
            php .github/scripts/check-solid.php llama3.2 "$BASE_REF" "$HEAD_REF"
  
            REPORT_FILE="${GITHUB_WORKSPACE}/.github/solid-reports/solid-report.md"
            if [ -f "$REPORT_FILE" ]; then
              echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
              echo "report_exists=true" >> $GITHUB_OUTPUT
              echo ""
              echo "üìã Rapport SOLID g√©n√©r√©:"
              cat "$REPORT_FILE"
            else
              echo "report_exists=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Aucun rapport g√©n√©r√© (peut-√™tre aucun fichier PHP modifi√©)"
            fi
  
      - name: Comment PR with SOLID report
          # üëâ always() pour qu'il s'ex√©cute m√™me si le step pr√©c√©dent a "fail"
        if: always() && github.event_name == 'pull_request' && steps.solid-check.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              const fs = require('fs');
              const reportFile = '${{ steps.solid-check.outputs.report_file }}';
              
              let report = '## üîç Analyse SOLID\n\n';
              report += 'Analyse automatique des principes SOLID effectu√©e sur les fichiers PHP modifi√©s.\n\n';
              report += '---\n\n';
              
              try {
                if (fs.existsSync(reportFile)) {
                  const content = fs.readFileSync(reportFile, 'utf8');
                  report += content;
                } else {
                  report += '‚ö†Ô∏è Impossible de r√©cup√©rer le rapport complet. Consultez les logs de la CI pour plus de d√©tails.';
                }
              } catch (error) {
                report += `‚ö†Ô∏è Erreur lors de la lecture du rapport: ${error.message}`;
              }
              
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('üîç Analyse SOLID')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: report
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              }
  
      - name: Fail workflow if SOLID check failed
          # üëâ on regarde si le step SOLID a eu outcome = failure
        if: steps.solid-check.outcome == 'failure'
        run: |
            echo "‚ùå SOLID check a d√©tect√© des violations majeures."
            exit 1
  
      # --- Tests applicatifs ---

      - name: Wait before running tests
        run: sleep 60

      - name: Run tests
        run: make tests

      - name: Stop Docker Compose services
        if: always()
        run: ${{ steps.docker-compose.outputs.cmd }} down -v
