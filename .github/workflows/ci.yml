name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # pour commenter un commit
      pull-requests: write   # pour commenter une PR
      checks: write          # pour cr√©er un CheckRun

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_pgsql, intl, mbstring, zip, xml, dom
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install Symfony CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | sudo -E bash
          sudo apt install symfony-cli

      - name: Set up Docker Compose
        id: docker-compose
        run: |
          if command -v docker-compose &> /dev/null; then
            echo "cmd=docker-compose" >> $GITHUB_OUTPUT
          else
            echo "cmd=docker compose" >> $GITHUB_OUTPUT
          fi

      - name: Start Docker Compose services
        run: ${{ steps.docker-compose.outputs.cmd }} up -d

      - name: Wait for database to be ready
        run: |
          DOCKER_CMD="${{ steps.docker-compose.outputs.cmd }}"
          until $DOCKER_CMD exec -T database pg_isready -U ${POSTGRES_USER:-app} -d ${POSTGRES_DB:-app}; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Wait for FusionAuth to be ready
        run: |
          DOCKER_CMD="${{ steps.docker-compose.outputs.cmd }}"
          echo "Waiting for FusionAuth to be ready..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s http://localhost:9011/api/status >/dev/null 2>&1; then
              echo "FusionAuth is ready!"
              break
            fi
            echo "Waiting for FusionAuth... (attempt $((attempt+1))/$max_attempts)"
            sleep 5
            attempt=$((attempt+1))
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "FusionAuth failed to start after $max_attempts attempts"
            exit 1
          fi

      - name: Validate composer files
        run: composer validate --no-check-all --no-check-publish

      - name: Composer security audit
        run: composer audit

#      - name: Check code style with PHP-CS-Fixer
#        run: vendor/bin/php-cs-fixer fix --dry-run --diff

#      - name: Run PHPStan
#        run: vendor/bin/phpstan analyse src/

#      - name: Run PHPMD
#        run: vendor/bin/phpmd src text phpmd.xml

#      - name: Run Deptrac
#        run: vendor/bin/deptrac

      - name: Lint Symfony container
        run: bin/console lint:container

      - name: Lint YAML files
        run: bin/console lint:yaml config/

      # --- IA / OLLAMA (requis pour inspecta-ai) ---

      - name: Setup Ollama
        uses: ai-action/setup-ollama@v1

      - name: Cache Ollama models
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-cache-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-ollama-cache-

      - name: Pull LLM model
        run: ollama pull llama3.2

      - name: SOLID check with inspecta-ai
        id: solid-check
        run: |
          set -o pipefail

          # D√©terminer les commits √† comparer
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.sha }}"
          fi

          echo "Base ref: $BASE_REF"
          echo "Head ref: $HEAD_REF"

          SOLID_EXIT_CODE=0
          php .github/scripts/check-solid.php "$BASE_REF" "$HEAD_REF" || SOLID_EXIT_CODE=$?

          echo "solid_exit_code=$SOLID_EXIT_CODE" >> $GITHUB_OUTPUT

          REPORT_FILE="${GITHUB_WORKSPACE}/.github/solid-reports/solid-report.md"
          if [ -f "$REPORT_FILE" ]; then
            echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "üìã Rapport SOLID g√©n√©r√©:"
            cat "$REPORT_FILE"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Aucun rapport g√©n√©r√©"
          fi

          exit 0

      - name: Ajouter le rapport SOLID au check (step summary)
        if: steps.solid-check.outputs.report_exists == 'true'
        run: |
          echo "## üîç Analyse SOLID (IA)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "${{ steps.solid-check.outputs.report_file }}" >> $GITHUB_STEP_SUMMARY

      # --- CheckRun d√©di√© SOLID / IA ---
      - name: Cr√©er CheckRun SOLID / IA
        if: steps.solid-check.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        env:
          SOLID_EXIT_CODE: ${{ steps.solid-check.outputs.solid_exit_code }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;

            const report = fs.readFileSync('${{ steps.solid-check.outputs.report_file }}', 'utf8');
            const exitCode = process.env.SOLID_EXIT_CODE || '0';
            const conclusion = exitCode === '0' ? 'success' : 'failure';

            await github.rest.checks.create({
              owner,
              repo,
              name: 'SOLID / IA',
              head_sha: context.sha,
              status: 'completed',
              conclusion,
              output: {
                title: 'Analyse SOLID (IA)',
                summary: report,
              },
            });

      # --- Nettoyage des anciens commentaires PR ---
      - name: Delete previous SOLID comment (PR)
        if: github.event_name == 'pull_request' && steps.solid-check.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            for (const c of comments) {
              if (c.user.type === "Bot" && c.body.includes("<!-- SOLID-CHECK -->")) {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: c.id,
                });
              }
            }

      - name: Comment PR with SOLID report
        if: github.event_name == 'pull_request' && steps.solid-check.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('${{ steps.solid-check.outputs.report_file }}', 'utf8');

            const body =
              "<!-- SOLID-CHECK -->\n" +
              "## üîç Analyse SOLID (IA)\n\n" +
              "Analyse automatique des principes SOLID sur les fichiers PHP modifi√©s (src/ et tests/).\n\n" +
              "---\n\n" +
              report;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      # --- Nettoyage des anciens commentaires commit ---
      - name: Delete previous SOLID comment (commit)
        if: github.event_name == 'push' && steps.solid-check.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;

            const { data: comments } = await github.rest.repos.listCommentsForCommit({
              owner,
              repo,
              commit_sha: sha,
            });

            for (const c of comments) {
              if (c.user.type === "Bot" && c.body.includes("<!-- SOLID-CHECK -->")) {
                await github.rest.repos.deleteCommitComment({
                  owner,
                  repo,
                  comment_id: c.id,
                });
              }
            }

      - name: Comment commit with SOLID report
        if: github.event_name == 'push' && steps.solid-check.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('${{ steps.solid-check.outputs.report_file }}', 'utf8');

            const body =
              "<!-- SOLID-CHECK -->\n" +
              "üîç **Analyse SOLID (IA)**\n\n" +
              "Analyse automatique des principes SOLID sur les fichiers PHP modifi√©s (src/ et tests/).\n\n" +
              "---\n\n" +
              report;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body,
            });

      # --- Tests ---

      - name: Run tests
        run: make tests

      - name: Stop Docker Compose services
        if: always()
        run: ${{ steps.docker-compose.outputs.cmd }} down -v

      - name: Fail workflow if SOLID check failed
        if: always() && steps.solid-check.outputs.solid_exit_code != '0'
        run: |
          echo "‚ùå SOLID check d√©tecte des violations SOLID majeures."
          exit 1
