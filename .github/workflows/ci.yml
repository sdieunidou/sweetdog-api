name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_pgsql, intl, mbstring, zip, xml, dom
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Validate composer files
        run: composer validate --no-check-all --no-check-publish

      - name: Composer security audit
        run: composer audit

      - name: Lint Symfony container
        run: bin/console lint:container

      - name: Lint YAML files
        run: bin/console lint:yaml config/

  tests:
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_pgsql, intl, mbstring, zip, xml, dom
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Set up Docker Compose
        id: docker-compose
        run: |
          if command -v docker-compose &> /dev/null; then
            echo "cmd=docker-compose" >> $GITHUB_OUTPUT
          else
            echo "cmd=docker compose" >> $GITHUB_OUTPUT
          fi

      - name: Start Docker Compose services
        run: ${{ steps.docker-compose.outputs.cmd }} up -d

      - name: Wait for database to be ready
        run: |
          DOCKER_CMD="${{ steps.docker-compose.outputs.cmd }}"
          until $DOCKER_CMD exec -T database pg_isready -U ${POSTGRES_USER:-app} -d ${POSTGRES_DB:-app}; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Wait for FusionAuth to be ready
        run: |
          DOCKER_CMD="${{ steps.docker-compose.outputs.cmd }}"
          echo "Waiting for FusionAuth to be ready..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s http://localhost:9011/api/status >/dev/null 2>&1; then
              echo "FusionAuth is ready!"
              break
            fi
            echo "Waiting for FusionAuth... (attempt $((attempt+1))/$max_attempts)"
            sleep 5
            attempt=$((attempt+1))
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "FusionAuth failed to start after $max_attempts attempts"
            exit 1
          fi

      - name: Install Symfony CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | sudo -E bash
          sudo apt install symfony-cli

      - name: Check code style with PHP-CS-Fixer
        run: vendor/bin/php-cs-fixer fix --dry-run --diff
  
      - name: Run PHPStan
        run: vendor/bin/phpstan analyse src/
  
      - name: Run PHPMD
        run: vendor/bin/phpmd src text phpmd.xml
  
      - name: Run Deptrac
        run: vendor/bin/deptrac

      - name: Wait before running tests
        run: sleep 60

      - name: Run tests
        run: make tests

      - name: Stop Docker Compose services
        if: always()
        run: ${{ steps.docker-compose.outputs.cmd }} down -v

  solid-ai:
    runs-on: ubuntu-latest
    needs: lint
    continue-on-error: true
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed PHP files
        id: detect-php-changes
        run: |
          set -o pipefail

          mkdir -p .github/solid-tmp

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.sha }}"
          fi

          CHANGED_FILES=$(git diff --name-only "$BASE_REF" "$HEAD_REF" || true)
          PHP_CHANGED=$(echo "${CHANGED_FILES}" | grep -E '^(src|tests)/.*\.php$' || true)

          if [ -n "${PHP_CHANGED}" ]; then
            echo "${PHP_CHANGED}"
            echo "${PHP_CHANGED}" > .github/solid-tmp/php-files.txt
            echo "has_php_changes=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Aucun fichier PHP modifiÃ© dans src/ ou tests/."
            echo "has_php_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_pgsql, intl, mbstring, zip, xml, dom
          coverage: none
  
      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-
  
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
  
      - name: Setup Ollama
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        uses: ai-action/setup-ollama@v1

      - name: Cache Ollama models
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-cache-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-ollama-cache-

      - name: Pull LLM model
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        run: ollama pull llama3.2

      - name: Run inspecta-ai for SOLID
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        id: solid-inspecta
        run: |
          set -o pipefail

          mkdir -p .github/solid-reports

          RAW_FILE=".github/solid-reports/inspecta-solid-raw.json"
          FILES=$(cat .github/solid-tmp/php-files.txt)

          echo "Analyse Inspecta-AI (solid_violations) sur les fichiers suivants :"
          echo "$FILES"

          ./vendor/bin/inspecta-ai analyze solid_violations $FILES > "$RAW_FILE"
          echo "raw_response_file=$RAW_FILE" >> $GITHUB_OUTPUT

          echo "Contenu de $RAW_FILE :"
          cat "$RAW_FILE"

      - name: Parse inspecta response
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        id: parse-response
        run: |
          NORMALIZED_FILE=".github/solid-reports/inspecta-solid-normalized.json"

          php .github/scripts/parse_response.php \
            "${{ steps.solid-inspecta.outputs.raw_response_file }}" \
            "$NORMALIZED_FILE"

          echo "normalized_file=$NORMALIZED_FILE" >> $GITHUB_OUTPUT

      - name: Emit SOLID annotations
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        run: |
          php .github/scripts/emit_annotations.php \
            "${{ steps.parse-response.outputs.normalized_file }}"

      - name: Generate SOLID markdown report
        if: steps.detect-php-changes.outputs.has_php_changes == 'true'
        id: generate-report
        run: |
          REPORT_FILE=".github/solid-reports/solid-report.md"

          php .github/scripts/generate_solid_report.php \
            "${{ steps.parse-response.outputs.normalized_file }}" \
            "$REPORT_FILE" || true

          if [ -f "$REPORT_FILE" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Ajouter le rapport SOLID au summary
        if: steps.generate-report.outputs.report_exists == 'true'
        run: |
          echo "## ðŸ” Analyse SOLID (IA)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "${{ steps.generate-report.outputs.report_file }}" >> $GITHUB_STEP_SUMMARY
